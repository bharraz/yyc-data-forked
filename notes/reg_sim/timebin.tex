\documentclass[10pt,fleqn]{article}
% \usepackage[journal=rsc]{chemstyle}
% \usepackage{mhchem}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsfonts}
\usepackage{esint}
\usepackage{bbm}
\usepackage{amscd}
\usepackage{picinpar}
\usepackage{graphicx}
\usepackage{tikz}
\usepackage{tikz-3dplot}
\usepackage{indentfirst}
\usepackage{wrapfig}
\usepackage{units}
\usepackage{textcomp}
\usepackage[utf8x]{inputenc}
% \usepackage{feyn}
% \usepackage{feynmp}
\usepackage{xkeyval}
\usepackage{xargs}
\usepackage{verbatim}
\usepackage{pgfplots}
\usepackage{hyperref}
\usetikzlibrary{
  arrows,
  calc,
  decorations.pathmorphing,
  decorations.pathreplacing,
  decorations.markings,
  fadings,
  positioning,
  shapes
}

\pgfdeclareradialshading{glow2}{\pgfpoint{0cm}{0cm}}{
  color(0mm)=(white);
  color(2mm)=(white);
  color(8mm)=(black);
  color(10mm)=(black)
}
\pgfdeclareradialshading{glow}{\pgfpoint{0cm}{0cm}}{
  color(0mm)=(white);
  color(5mm)=(white);
  color(9mm)=(black);
  color(10mm)=(black)
}

\begin{tikzfadingfrompicture}[name=glow fading]
  \shade [shading=glow] (0,0) circle (1);
\end{tikzfadingfrompicture}

\begin{tikzfadingfrompicture}[name=glow2 fading]
  \shade [shading=glow2] (0,0) circle (1);
\end{tikzfadingfrompicture}

\definecolor{pyplotc0}{rgb}{0.122,0.467,0.706}
\definecolor{pyplotc1}{rgb}{1.000,0.498,0.055}
\definecolor{pyplotc2}{rgb}{0.173,0.627,0.173}
\definecolor{pyplotc3}{rgb}{0.839,0.153,0.157}
\definecolor{pyplotc4}{rgb}{0.580,0.404,0.741}
\definecolor{pyplotc5}{rgb}{0.549,0.337,0.294}
\definecolor{pyplotc6}{rgb}{0.890,0.467,0.761}
\definecolor{pyplotc7}{rgb}{0.498,0.498,0.498}
\definecolor{pyplotc8}{rgb}{0.737,0.741,0.133}
\definecolor{pyplotc9}{rgb}{0.090,0.745,0.812}

\DeclareGraphicsRule{*}{mps}{*}{}
\newcommand{\ud}{\mathrm{d}}
\newcommand{\ue}{\mathrm{e}}
\newcommand{\ui}{\mathrm{i}}
\newcommand{\res}{\mathrm{Res}}
\newcommand{\Tr}{\mathrm{Tr}}
\newcommand{\dsum}{\displaystyle\sum}
\newcommand{\dprod}{\displaystyle\prod}
\newcommand{\dlim}{\displaystyle\lim}
\newcommand{\dint}{\displaystyle\int}
\newcommand{\fsno}[1]{{\!\not\!{#1}}}
\newcommand{\eqar}[1]
{
  \begin{align}
    #1
  \end{align}
}
\newcommand{\texp}[2]{\ensuremath{{#1}\times10^{#2}}}
\newcommand{\dexp}[2]{\ensuremath{{#1}\cdot10^{#2}}}
\newcommand{\eval}[2]{{\left.{#1}\right|_{#2}}}
\newcommand{\paren}[1]{{\left({#1}\right)}}
\newcommand{\lparen}[1]{{\left({#1}\right.}}
\newcommand{\rparen}[1]{{\left.{#1}\right)}}
\newcommand{\abs}[1]{{\left|{#1}\right|}}
\newcommand{\sqr}[1]{{\left[{#1}\right]}}
\newcommand{\crly}[1]{{\left\{{#1}\right\}}}
\newcommand{\angl}[1]{{\left\langle{#1}\right\rangle}}
\newcommand{\tpdiff}[4][{}]{{\paren{\frac{\partial^{#1} {#2}}{\partial {#3}{}^{#1}}}_{#4}}}
\newcommand{\tpsdiff}[4][{}]{{\paren{\frac{\partial^{#1}}{\partial {#3}{}^{#1}}{#2}}_{#4}}}
\newcommand{\pdiff}[3][{}]{{\frac{\partial^{#1} {#2}}{\partial {#3}{}^{#1}}}}
\newcommand{\diff}[3][{}]{{\frac{\ud^{#1} {#2}}{\ud {#3}{}^{#1}}}}
\newcommand{\psdiff}[3][{}]{{\frac{\partial^{#1}}{\partial {#3}{}^{#1}} {#2}}}
\newcommand{\sdiff}[3][{}]{{\frac{\ud^{#1}}{\ud {#3}{}^{#1}} {#2}}}
\newcommand{\tpddiff}[4][{}]{{\left(\dfrac{\partial^{#1} {#2}}{\partial {#3}{}^{#1}}\right)_{#4}}}
\newcommand{\tpsddiff}[4][{}]{{\paren{\dfrac{\partial^{#1}}{\partial {#3}{}^{#1}}{#2}}_{#4}}}
\newcommand{\pddiff}[3][{}]{{\dfrac{\partial^{#1} {#2}}{\partial {#3}{}^{#1}}}}
\newcommand{\ddiff}[3][{}]{{\dfrac{\ud^{#1} {#2}}{\ud {#3}{}^{#1}}}}
\newcommand{\psddiff}[3][{}]{{\frac{\partial^{#1}}{\partial{}^{#1} {#3}} {#2}}}
\newcommand{\sddiff}[3][{}]{{\frac{\ud^{#1}}{\ud {#3}{}^{#1}} {#2}}}
\usepackage{fancyhdr}
\usepackage{multirow}
\usepackage{fontenc}
% \usepackage{tipa}
\usepackage{ulem}
\usepackage{color}
\usepackage{cancel}
\newcommand{\hcancel}[2][black]{\setbox0=\hbox{#2}%
  \rlap{\raisebox{.45\ht0}{\textcolor{#1}{\rule{\wd0}{1pt}}}}#2}
\pagestyle{fancy}
\setlength{\headheight}{67pt}
\fancyhead{}
\fancyfoot{}
\fancyfoot[C]{\thepage}
\fancyhead[R]{}
\renewcommand{\footruleskip}{0pt}
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0pt}

\newcommand\pgfmathsinandcos[3]{%
  \pgfmathsetmacro#1{sin(#3)}%
  \pgfmathsetmacro#2{cos(#3)}%
}
\newcommand\LongitudePlane[3][current plane]{%
  \pgfmathsinandcos\sinEl\cosEl{#2} % elevation
  \pgfmathsinandcos\sint\cost{#3} % azimuth
  \tikzset{#1/.estyle={cm={\cost,\sint*\sinEl,0,\cosEl,(0,0)}}}
}
\newcommand\LatitudePlane[3][current plane]{%
  \pgfmathsinandcos\sinEl\cosEl{#2} % elevation
  \pgfmathsinandcos\sint\cost{#3} % latitude
  \pgfmathsetmacro\yshift{\cosEl*\sint}
  \tikzset{#1/.estyle={cm={\cost,0,0,\cost*\sinEl,(0,\yshift)}}} %
}
\newcommand\DrawLongitudeCircle[2][1]{
  \LongitudePlane{\angEl}{#2}
  \tikzset{current plane/.prefix style={scale=#1}}
  % angle of "visibility"
  \pgfmathsetmacro\angVis{atan(sin(#2)*cos(\angEl)/sin(\angEl))} %
  \draw[current plane] (\angVis:1) arc (\angVis:\angVis+180:1);
  \draw[current plane,dashed] (\angVis-180:1) arc (\angVis-180:\angVis:1);
}
\newcommand\DrawLatitudeCircleArrow[2][1]{
  \LatitudePlane{\angEl}{#2}
  \tikzset{current plane/.prefix style={scale=#1}}
  \pgfmathsetmacro\sinVis{sin(#2)/cos(#2)*sin(\angEl)/cos(\angEl)}
  % angle of "visibility"
  \pgfmathsetmacro\angVis{asin(min(1,max(\sinVis,-1)))}
  \draw[current plane,decoration={markings, mark=at position 0.6 with {\arrow{<}}},postaction={decorate},line width=.6mm] (\angVis:1) arc (\angVis:-\angVis-180:1);
  \draw[current plane,dashed,line width=.6mm] (180-\angVis:1) arc (180-\angVis:\angVis:1);
}
\newcommand\DrawLatitudeCircle[2][1]{
  \LatitudePlane{\angEl}{#2}
  \tikzset{current plane/.prefix style={scale=#1}}
  \pgfmathsetmacro\sinVis{sin(#2)/cos(#2)*sin(\angEl)/cos(\angEl)}
  % angle of "visibility"
  \pgfmathsetmacro\angVis{asin(min(1,max(\sinVis,-1)))}
  \draw[current plane] (\angVis:1) arc (\angVis:-\angVis-180:1);
  \draw[current plane,dashed] (180-\angVis:1) arc (180-\angVis:\angVis:1);
}
\newcommand\coil[1]{
  {\rh * cos(\t * pi r)}, {\apart * (2 * #1 + \t) + \rv * sin(\t * pi r)}
}
\makeatletter
\define@key{DrawFromCenter}{style}[{->}]{
  \tikzset{DrawFromCenterPlane/.style={#1}}
}
\define@key{DrawFromCenter}{r}[1]{
  \def\@R{#1}
}
\define@key{DrawFromCenter}{center}[(0, 0)]{
  \def\@Center{#1}
}
\define@key{DrawFromCenter}{theta}[0]{
  \def\@Theta{#1}
}
\define@key{DrawFromCenter}{phi}[0]{
  \def\@Phi{#1}
}
\presetkeys{DrawFromCenter}{style, r, center, theta, phi}{}
\newcommand*\DrawFromCenter[1][]{
  \setkeys{DrawFromCenter}{#1}{
    \pgfmathsinandcos\sint\cost{\@Theta}
    \pgfmathsinandcos\sinp\cosp{\@Phi}
    \pgfmathsinandcos\sinA\cosA{\angEl}
    \pgfmathsetmacro\DX{\@R*\cost*\cosp}
    \pgfmathsetmacro\DY{\@R*(\cost*\sinp*\sinA+\sint*\cosA)}
    \draw[DrawFromCenterPlane] \@Center -- ++(\DX, \DY);
  }
}
\newcommand*\DrawFromCenterText[2][]{
  \setkeys{DrawFromCenter}{#1}{
    \pgfmathsinandcos\sint\cost{\@Theta}
    \pgfmathsinandcos\sinp\cosp{\@Phi}
    \pgfmathsinandcos\sinA\cosA{\angEl}
    \pgfmathsetmacro\DX{\@R*\cost*\cosp}
    \pgfmathsetmacro\DY{\@R*(\cost*\sinp*\sinA+\sint*\cosA)}
    \draw[DrawFromCenterPlane] \@Center -- ++(\DX, \DY) node {#2};
  }
}
\makeatother

\makeatletter
\renewcommand*\env@matrix[1][\arraystretch]{%
  \edef\arraystretch{#1}%
  \hskip -\arraycolsep
  \let\@ifnextchar\new@ifnextchar
  \array{*\c@MaxMatrixCols c}}
\makeatother

\tikzstyle{snakearrow} = [decorate, decoration={pre length=0.2cm,
  post length=0.2cm, snake, amplitude=.4mm,
  segment length=2mm},thick, ->]
%% document-wide tikz options and styles
\tikzset{%
  >=latex, % option for nice arrows
  inner sep=0pt,%
  outer sep=2pt,%
  mark coordinate/.style={inner sep=0pt,outer sep=0pt,minimum size=3pt,
    fill=black,circle}%
}
\addtolength{\hoffset}{-1.3cm}
\addtolength{\voffset}{-2cm}
\addtolength{\textwidth}{3cm}
\addtolength{\textheight}{2.5cm}
\renewcommand{\footskip}{10pt}
\setlength{\headwidth}{\textwidth}
\setlength{\headsep}{20pt}
\setlength{\marginparwidth}{0pt}
\parindent=0pt
\title{Simulation of time-bin remote entanglement generation}

\ifpdf
  % Ensure reproducible output
  \pdfinfoomitdate=1
  \pdfsuppressptexinfo=-1
  \pdftrailerid{}
  \hypersetup{
    pdfcreator={},
    pdfproducer={}
  }
\fi

\begin{document}

\maketitle

\section{Full quantum treatment of the position/motion-dependent
  decoherence}

\subsection{From position-dependent phase to recoil}

The interaction between an atom and the photon depends on the position of the atom.
For excitation, the phase of the light affects the phase of the atomic excited state
wavefunction\footnote{For a $\pi$-pulse, this is a global phase for a two-level system
  which can be ignored. However the time-bin entanglement scheme necessitate at least
  a three-level system. In such a system,
  this phase isn't global anymore and can be experimentally observed
  by comparing it to the third state}.
For emission, the position of the atom affects the phase of the emitted photon.\\

This becomes a source of decoherence for time-bin entanglement on atomic systems.
Classically, we can understand this since the position of the atom is not necessarily
the same during the first and the second excitation/photon emission
causing a different and random phase on the photon which averages out
the coherence fringes. However, this predicts that there would be no decoherence
if the motional state of the atom is stationary
(i.e. if the atom is in the ground motional state
or any of the Fock states $|n\rangle$). Since the thermal state can be expressed
as a probabilistic mixture of pure Fock states, this conclusion
cannot possibly be correct.\\

To handle this correctly, we need to construct the unitary operation that corresponds
to the photon generation step. Without the position-dependent phase effect,
this step maps the atomic (internal) wavefunction in the following way,
\eqar{
  |0\rangle\rightarrow&|0;\mathrm{ph}\rangle\\
  |i\rangle\rightarrow&|i\rangle
}
where the $\mathrm{ph}$ represent a photon being generated and $i\neq0$
are the internal states of the atom that were not excited.
When the effect of the motion is included, we can still use the classical picture
to write out the new wavefunction.
Instead of a fixed phase when the photon is generated, we acquire a phase
from the absorbed and emitted photon,
\eqar{
  |0,\vec r\rangle\rightarrow&\ue^{\ui\Delta\vec k\cdot\vec r}|0,\vec r;\mathrm{ph}\rangle\\
  |i,\vec r\rangle\rightarrow&|i,\vec r\rangle
}
where $\Delta\vec k$ is the difference between the wavevectors of the absorbed
and emitted photon. Note that although we've stated the position dependent phase factor
as being on the photon, it, being just a phase, can be treated as acting on any part
of the wavefunction, including the motional wavefunction of the atom.
Viewing this way, it is essentially the recoil on the motion of the atom
and it creates entanglement between spin+photon state
and the motional state of the atom.\\

Based on this understanding, the correct (or at least an equivalent) way
to view the motion/position dependent decoherence is that (Fig.~\ref{fig:recoil-trajectory}),
\begin{enumerate}
\item During the first photon generation step, the $|0\rangle$ spin state
  receives a recoil from the absorbed/emitted photon while the $|1\rangle$ spin state
  remains in the original motional state.
\item During the time between the two excitations,
  the motion of the atom evolves freely (and differently
  due to the different initial motional state
  between the $|0\rangle$ and $|1\rangle$ spin states).
\item During the second photon generation step, the $|1\rangle$ spin state
  receives a recoil from the absorbed/emitted photon while the motion for the
  $|0\rangle$ spin state remains unchanged.
\item At this stage, the $|0\rangle$ motional state underwent
  recoil and then free evolution
  whereas the $|1\rangle$ motional state underwent free evolution and then recoil.
  If these two resulting motional states are not exactly the same,
  we've created a unwanted entanglement between the spin and the atom motion
  which reduces the fidelity of the spin+photon state that we would like to create\footnote{Much the same way motional closure error reduces the fidelity of a M{\o}lmer-S{\o}rensen gate}.
\end{enumerate}

\def\initX{0.5}
\def\initY{0.6}
\def\kickDY{0.45}
\def\cloudR{0.25}
\def\frameLen{2.0}

\def\kickY{(\initY+\kickDY)}
\def\initR{((\initX^2+\initY^2)^0.5)}
\def\kickR{((\initX^2+\kickY^2)^0.5)}
\begin{figure}
  \centering
  \begin{tikzpicture}
    \draw[->,>=stealth,line width=1] (-\frameLen, 0) -- (\frameLen, 0) node[below] {$x$};
    \draw[->,>=stealth,line width=1] (0, -\frameLen) -- (0, \frameLen) node[right] {$p$};

    \fill[pyplotc3,path fading=glow2 fading,opacity=0.66]
    (\initX,\initY) circle (\cloudR);
    \fill[pyplotc0,path fading=glow2 fading,opacity=0.66]
    (\initX,{\kickY}) circle (\cloudR);

    \draw[->,>=stealth,line width=1,pyplotc0] (\initX, \initY) -- (\initX, {\kickY});
  \end{tikzpicture}
  \begin{tikzpicture}
    \draw[->,>=stealth,line width=1] (-\frameLen, 0) -- (\frameLen, 0) node[below] {$x$};
    \draw[->,>=stealth,line width=1] (0, -\frameLen) -- (0, \frameLen) node[right] {$p$};

    \fill[pyplotc3,path fading=glow2 fading,opacity=0.66]
    (\initX,\initY) circle (\cloudR);
    \fill[pyplotc0,path fading=glow2 fading,opacity=0.66]
    (\initX,{\kickY}) circle (\cloudR);

    \draw[->,>=stealth,line width=1,pyplotc0] (\initX, {\kickY}) arc
    [start angle={atan(\kickY/\initX)},
    end angle={atan(\kickY/\initX)-360},
    x radius=\kickR,
    y radius=\kickR
    ];

    \draw[->,>=stealth,line width=1,pyplotc3] (\initX, \initY) arc
    [start angle={atan(\initY/\initX)},
    end angle={atan(\initY/\initX)-360},
    x radius=\initR,
    y radius=\initR
    ];
  \end{tikzpicture}
  \begin{tikzpicture}
    \draw[->,>=stealth,line width=1] (-\frameLen, 0) -- (\frameLen, 0) node[below] {$x$};
    \draw[->,>=stealth,line width=1] (0, -\frameLen) -- (0, \frameLen) node[right] {$p$};

    \fill[pyplotc3!50!pyplotc0,path fading=glow2 fading,opacity=0.66]
    (\initX,{\kickY}) circle (\cloudR);
    \draw[->,>=stealth,line width=1,pyplotc3] (\initX, \initY) -- (\initX, {\kickY});
  \end{tikzpicture}
  \caption{\label{fig:recoil-trajectory}}
\end{figure}

\begin{figure}
  \centering
  \begin{tikzpicture}
    \def\initX{1.1}
    \def\initY{1.2}
    \def\kickDY{1.4}
    \def\cloudR{0.25}
    \def\frameLen{3.5}

    \def\kickY{(\initY+\kickDY)}
    \def\initR{((\initX^2+\initY^2)^0.5)}
    \def\kickR{((\initX^2+\kickY^2)^0.5)}
    \draw[->,>=stealth,line width=1] (-\frameLen, 0) -- (\frameLen, 0) node[below] {$x$};
    \draw[->,>=stealth,line width=1] (0, -\frameLen) -- (0, \frameLen) node[right] {$p$};

    \fill[pyplotc3!50!pyplotc0,path fading=glow2 fading,opacity=0.8]
    (\initX,\initY) circle (\cloudR);

    \draw[->,>=stealth,line width=1,pyplotc0] (\initX, \initY) -- +(0, \kickDY)
    coordinate (P01);
    \draw[->,>=stealth,line width=1,pyplotc0] (P01) arc
    [start angle={atan(\kickY/\initX)},
    end angle={atan(\kickY/\initX)-90},
    x radius=\kickR,
    y radius=\kickR
    ]
    coordinate (P0m1)
    arc
    [start angle={atan(\kickY/\initX)-90},
    end angle={atan(\kickY/\initX)-180},
    x radius=\kickR,
    y radius=\kickR
    ]
    coordinate (P0m2)
    arc
    [start angle={atan(\kickY/\initX)-180},
    end angle={atan(\kickY/\initX)-270},
    x radius=\kickR,
    y radius=\kickR
    ]
    coordinate (P0m3)
    arc
    [start angle={atan(\kickY/\initX)-270},
    end angle={atan(\kickY/\initX)-350},
    x radius=\kickR,
    y radius=\kickR
    ] coordinate (P02);

    \draw[->,>=stealth,line width=1,pyplotc3] (\initX, \initY) arc
    [start angle={atan(\initY/\initX)},
    end angle={atan(\initY/\initX)-90},
    x radius=\initR,
    y radius=\initR
    ]
    coordinate (P1m1)
    arc
    [start angle={atan(\initY/\initX)-90},
    end angle={atan(\initY/\initX)-180},
    x radius=\initR,
    y radius=\initR
    ]
    coordinate (P1m2)
    arc
    [start angle={atan(\initY/\initX)-180},
    end angle={atan(\initY/\initX)-270},
    x radius=\initR,
    y radius=\initR
    ]
    coordinate (P1m3)
    arc
    [start angle={atan(\initY/\initX)-270},
    end angle={atan(\initY/\initX)-350},
    x radius=\initR,
    y radius=\initR
    ] coordinate (P11);
    \draw[->,>=stealth,line width=1,pyplotc3] (P11) -- +(0, \kickDY)
    coordinate (P12);

    \fill[pyplotc0,path fading=glow2 fading,opacity=0.35]
    (P0m1) circle (\cloudR);
    \fill[pyplotc3,path fading=glow2 fading,opacity=0.35]
    (P1m1) circle (\cloudR);
    \fill[pyplotc0,path fading=glow2 fading,opacity=0.35]
    (P0m2) circle (\cloudR);
    \fill[pyplotc3,path fading=glow2 fading,opacity=0.35]
    (P1m2) circle (\cloudR);
    \fill[pyplotc0,path fading=glow2 fading,opacity=0.35]
    (P0m3) circle (\cloudR);
    \fill[pyplotc3,path fading=glow2 fading,opacity=0.35]
    (P1m3) circle (\cloudR);

    \fill[pyplotc0,path fading=glow2 fading,opacity=0.8]
    (P02) circle (\cloudR);
    \fill[pyplotc3,path fading=glow2 fading,opacity=0.8]
    (P12) circle (\cloudR);
  \end{tikzpicture}
  \caption{\label{fig:recoil-trajectory}}
\end{figure}

\subsection{Calculation}

To calculate the fidelity caused by this entanglement, we need to calculate
the reduced density matrix of the spin and photon after the two photon generation steps.
Here we'll make a few simplifications and ignore some independent error sources
that can be taken into account separately,
\begin{enumerate}
\item We'll assume the excitation is complete
  and also ignore any branching into other spin states.
\item We'll assume the two qubit states are excited directly.
  In a real experiment the two photon excitation is more likely to be done
  on the same transition after swapping the two qubit state between the two excitations.
\item We'll only calculate up to the photon generated from the atom.
  After we've obtained the density matrix of an ion and the photon(s) it has generated,
  the effect of the photon collection/interference/detection etc.,
  can be considered separately.
\item For simplicity, since full excitation is assumed,
  we'll omit the photon state in the notation below. It should be understood as
  $|0\rangle$ representing $|0;\mathrm{early\ photon}\rangle$ after the first photon
  generation step, and $|1\rangle$ representing $|1;\mathrm{late\ photon}\rangle$
  after the second photon generation step.
\item We'll calculate for a single motional axis
  (and assume it's a harmonic oscillator).
  As long as there's no initial entanglment between the motions on different axis,
  the result of the calculation can just be applied on each axis independently.
\end{enumerate}

With these simplifications, the initial density matrix of the system is,
\eqar{
  \begin{split}
    \rho_0=&\frac{\paren{|0\rangle+|1\rangle}\paren{\langle0|+\langle1|}}{2}\rho_{\mathrm{m}}
  \end{split}
}
where $\rho_{\mathrm{m}}$ is the motional density matrix.\\

After first photon generation, the density matrix is,
\eqar{
  \begin{split}
    \rho_1=&\paren{P_{0}\mathcal{D}(\ui\eta)+P_{1}}\rho_0\paren{P_{0}\mathcal{D}(-\ui\eta)+P_{1}}
  \end{split}
}
where $P_0$ and $P_1$ are the projection operators for the $|0\rangle$ and $|1\rangle$
states respectively, $\mathcal{D}(\ui\eta)=\ue^{\ui kx}$ is the displacement operator
representing the effect of the photon recoil and $\eta$ is the Lamb-Dicke parameter.\\

After the free-evolution between the two generation steps,
\eqar{
  \begin{split}
    \rho_2=&\ue^{-\ui n\omega t}\rho_1\ue^{\ui n\omega t}\\
    =&\ue^{-\ui n\omega t}\paren{P_{0}\mathcal{D}(\ui\eta)+P_{1}}\rho_0\paren{P_{0}\mathcal{D}(-\ui\eta)+P_{1}}\ue^{\ui n\omega t}
  \end{split}
}
where $\omega$ is the trap frequency.\\

After second photon gneeration,
\eqar{
  \begin{split}
    \rho_3=&\paren{P_{0}+P_{1}\mathcal{D}(\ui\eta)}\rho_2\paren{P_{0}+P_{1}\mathcal{D}(-\ui\eta)}\\
    =&\paren{P_{0}+P_{1}\mathcal{D}(\ui\eta)}\ue^{-\ui n\omega t}\paren{P_{0}\mathcal{D}(\ui\eta)+P_{1}}\rho_0\paren{P_{0}\mathcal{D}(-\ui\eta)+P_{1}}\ue^{\ui n\omega t}\paren{P_{0}+P_{1}\mathcal{D}(-\ui\eta)}\\
    =&\paren{P_{0}\ue^{-\ui n\omega t}\mathcal{D}(\ui\eta)+P_{1}\mathcal{D}(\ui\eta)\ue^{-\ui n\omega t}}\rho_0\paren{P_{0}\mathcal{D}(-\ui\eta)\ue^{\ui n\omega t}+P_{1}\ue^{\ui n\omega t}\mathcal{D}(-\ui\eta)}
  \end{split}
}
This result is currently generic and can be applied to any initial motional state.
For the experiment, however, we are more interested in using a thermal state
as the initial state. It is useful to use a representation of the density matrix
using coherent states (as will be obvious from the derivation below),

\eqar{
  \rho_{\mathrm{m}}=&\frac{1}{\pi {\bar n}}\int\ud^2\alpha |\alpha\rangle\langle\alpha|\ue^{-\abs{\alpha}^2/{\bar n}}
}
where ${\bar n}\equiv\dfrac{1}{\ue^{\beta\omega}-1}$ is the average $n$.\\

We can now write the final density matrix as,
\eqar{
  \begin{split}
    \rho_3=
    &\int\ud^2\alpha \frac{\ue^{-\abs{\alpha}^2/{\bar n}}}{2\pi {\bar n}}
      \paren{|0\rangle\ue^{-\ui n\omega t}\mathcal{D}(\ui\eta)+|1\rangle\mathcal{D}(\ui\eta)\ue^{-\ui n\omega t}}|\alpha\rangle\\
    &\langle\alpha|\paren{\langle0|\mathcal{D}(-\ui\eta)\ue^{\ui n\omega t}+\langle1|\ue^{\ui n\omega t}\mathcal{D}(-\ui\eta)}
  \end{split}
}

After tracing out the motion part, the spin reduced density matrix is,
\eqar{
  \begin{split}
    \rho_{3,\mathrm{s}}=
    &\int\ud^2\alpha \frac{\ue^{-\abs{\alpha}^2/{\bar n}}}{2\pi {\bar n}}
      \begin{pmatrix}[1.5]
        |0\rangle\langle0|
        \langle\alpha|\mathcal{D}(-\ui\eta)\ue^{\ui n\omega t}
        \ue^{-\ui n\omega t}\mathcal{D}(\ui\eta)|\alpha\rangle\\
        +|0\rangle\langle1|
        \langle\alpha|\ue^{\ui n\omega t}\mathcal{D}(-\ui\eta)
        \ue^{-\ui n\omega t}\mathcal{D}(\ui\eta)|\alpha\rangle
        \\
        +|1\rangle\langle0|
        \langle\alpha|\mathcal{D}(-\ui\eta)\ue^{\ui n\omega t}
        \mathcal{D}(\ui\eta)\ue^{-\ui n\omega t}|\alpha\rangle
        \\
        +|1\rangle\langle1|
        \langle\alpha|\ue^{\ui n\omega t}\mathcal{D}(-\ui\eta)
        \mathcal{D}(\ui\eta)\ue^{-\ui n\omega t}|\alpha\rangle
      \end{pmatrix}\\
    =&\int\ud^2\alpha \frac{\ue^{-\abs{\alpha}^2/{\bar n}}}{2\pi {\bar n}}
       \begin{pmatrix}[1.5]
         |0\rangle\langle0|
         +|1\rangle\langle1|\\
         +|0\rangle\langle1|
         \langle\alpha|\ue^{\ui n\omega t}\mathcal{D}(-\ui\eta)
         \ue^{-\ui n\omega t}\mathcal{D}(\ui\eta)|\alpha\rangle
         \\
         +|1\rangle\langle0|
         \langle\alpha|\mathcal{D}(-\ui\eta)\ue^{\ui n\omega t}
         \mathcal{D}(\ui\eta)\ue^{-\ui n\omega t}|\alpha\rangle
       \end{pmatrix}
  \end{split}
}

The coefficient on the off-diagonal term can be calculated as
(thanks to using the coherent states as the basis),
\eqar{
  \begin{split}
    &\langle\alpha|\mathcal{D}(-\ui\eta)\ue^{\ui n\omega t}
      \mathcal{D}(\ui\eta)\ue^{-\ui n\omega t}|\alpha\rangle\\
    =&\langle\alpha|\mathcal{D}(-\ui\eta)\ue^{\ui n\omega t}
       \mathcal{D}(\ui\eta)|\ue^{-\ui\omega t}\alpha\rangle\\
    =&\ue^{(\ui\eta\alpha^*\ue^{\ui\omega t}+\ui\eta\alpha\ue^{-\ui\omega t})/2}
       \ue^{(-\ui\eta\alpha^*-\ui\eta\alpha)/2}
       \langle\alpha+\ui\eta|\alpha+\ui\eta\ue^{\ui\omega t}\rangle\\
    =&\exp\paren{\frac12
       \begin{pmatrix}[1.5]
         \ui\eta\alpha^*\ue^{\ui\omega t}+\ui\eta\alpha\ue^{-\ui\omega t}
         -\ui\eta\alpha^*-\ui\eta\alpha\\
         -\abs{\alpha+\ui\eta}^2-\abs{\alpha+\ui\eta\ue^{\ui\omega t}}^2
         +2\paren{\alpha^*-\ui\eta}\paren{\alpha+\ui\eta\ue^{\ui\omega t}}
       \end{pmatrix}
       }\\
    =&\exp\begin{pmatrix}[1.5]
      \ui\eta\alpha\ue^{-\ui\omega t}-\ui\eta\alpha^*-\abs{\alpha}^2-\eta^2+\paren{\alpha^*-\ui\eta}\paren{\alpha+\ui\eta\ue^{\ui\omega t}}
    \end{pmatrix}\\
    =&\exp\begin{pmatrix}[1.5]
      2\ui\eta\mathrm{Re}\paren{\alpha\paren{\ue^{-\ui\omega t}-1}}
      +\eta^2\paren{\ue^{\ui\omega t}-1}
    \end{pmatrix}\\
  \end{split}
}
which gives us
\eqar{
  \begin{split}
    \rho_{3,\mathrm{s}}
    =&\int\ud^2\alpha \frac{\ue^{-\abs{\alpha}^2/{\bar n}}}{2\pi {\bar n}}
       \begin{pmatrix}[1.5]
         |0\rangle\langle0|
         +|1\rangle\langle1|\\
         +|0\rangle\langle1|
         \exp\paren{
         -2\ui\eta\mathrm{Re}\paren{\alpha\paren{\ue^{-\ui\omega t}-1}}
         +\eta^2\paren{\ue^{-\ui\omega t}-1}}\\
         +|1\rangle\langle0|
         \exp\paren{
         2\ui\eta\mathrm{Re}\paren{\alpha\paren{\ue^{-\ui\omega t}-1}}
         +\eta^2\paren{\ue^{\ui\omega t}-1}}
       \end{pmatrix}\\
    =&\frac{|0\rangle\langle0|+|1\rangle\langle1|}{2}+|0\rangle\langle1|\int\ud^2\alpha \frac{\ue^{-\abs{\alpha}^2/{\bar n}}}{2\pi {\bar n}}
       \exp\paren{
       -2\ui\eta\mathrm{Re}\paren{\alpha\paren{\ue^{-\ui\omega t}-1}}
       +\eta^2\paren{\ue^{-\ui\omega t}-1}}+h.c.
  \end{split}
}
And we can calculate the integral,
\eqar{
  \begin{split}
    &\int\ud^2\alpha \ue^{-\abs{\alpha}^2/{\bar n}}\exp\paren{
      2\ui\eta\mathrm{Re}\paren{\alpha\paren{\ue^{-\ui\omega t}-1}}
      +\eta^2\paren{\ue^{-\ui\omega t}-1}
      }\\
    =&\ue^{\eta^2\paren{\ue^{-\ui\omega t}-1}}
       \int\ud^2\alpha \ue^{-\abs{\alpha}^2/{\bar n}}\exp\paren{
       2\ui\eta\mathrm{Re}\paren{\paren{\alpha_x+\ui\alpha_y}\paren{\cos\omega t-1-\ui\sin\omega t}}}\\
    =&\ue^{\eta^2\paren{\ue^{-\ui\omega t}-1}}
       \int\ud^2\alpha
       \exp\paren{
       -\alpha_x^2/{\bar n}
       +2\ui\alpha_x\eta\paren{\cos\omega t-1}
       }
       \exp\paren{
       -\alpha_y^2/{\bar n}
       +2\ui\alpha_y\eta\sin\omega t
       }\\
    =&\pi {\bar n}\exp\paren{-\eta^2\paren{1-\ue^{-\ui\omega t}+2{\bar n}\paren{1-\cos\omega t}}}\\
    =&\pi {\bar n}\exp\paren{-\ui\eta^2\sin\omega t}\exp\paren{-\eta^2\paren{1-\cos\omega t}\paren{2{\bar n}+1}}
  \end{split}
}
And the final reduced density matrix,
\eqar{
  \begin{split}
    \rho_{3,\mathrm{s}}=&\frac{|0\rangle\langle0|+|1\rangle\langle1|+|0\rangle\langle1|\exp\paren{\ui\eta^2\sin\omega t}\exp\paren{-\eta^2\paren{1-\cos\omega t}\paren{2{\bar n}+1}}+h.c.}{2}
  \end{split}
}
The off-diagonal element of the reduced density matrix is the important part
that specifies the final spin (+ photon) state. This is the number that can
directly be multiplied when multiple motional axis is considered.\\

Its amplitude quatifies the purity of the spin state (i.e. parity scan contrast) which is
\eqar{
  \exp\paren{-\eta^2\paren{1-\cos\omega t}\paren{2{\bar n}+1}}
}

It's also worth noting that the is a small (and temperature independent)
spin phase factor as well (i.e. parity scan phase) that is
\eqar{
  \exp\paren{\ui\eta^2\sin\omega t}
}
The maximum phase is $\eta^2$ which can be completely ignored if $\eta$ is small enough.

\section{Motion of the atom during emission}

The discussion in the previous section assumes the emission of the photon to be
instantaneous. However, in reality, this happens over the lifetime of the excited state.
For photon that's emitted at different time, the recoil on the atom would also happen
at a different time, resulting in a different final atom motional wavefunction.
This resulting entanglement between the photon wavefunction and the motion wavefunction
could affect the fidelity of the final spin-entanglement.\\

For this discussion, we will ignore the effect of imperfect timing mismatch between
the two excitations since it's already covered above. We can then simply assume
that the two excitations happened at exactly the same time and label the two photon
states $|A\rangle$ and $|B\rangle$ instead. (This two photon states can be
early vs late for time-bin qubit, horizontal/vertical for polarization qubit
or different frequencies for frequency qubit.)\\

For an initial state of
\eqar{
  \begin{split}
    \rho_0=&\frac{\paren{|0\rangle+|1\rangle}\paren{\langle0|+\langle1|}}{2}\rho_{\mathrm{m}}
  \end{split}
}
After excitation the state is
\eqar{
  \begin{split}
    \rho_1=&\frac{\paren{|e_0\rangle+|e_1\rangle}\paren{\langle e_0|+\langle e_1|}}{2}\mathcal{D}(\ui\eta_{\mathrm{d}})\rho_{\mathrm{m}}\mathcal{D}(-\ui\eta_{\mathrm{d}})
  \end{split}
}
where $e_0$ and $e_1$ are the two excited states and,
$\eta_{\mathrm{d}}$ is the Lamb-Dicke parameter for the drive (excitation) photon.\\

Since the decay happen over a variable length of time,
it's difficult to put a bound on when the decay ``finished''.
Therefore, the post-decay wavefunction we'll use is the one that is
back-time-propagated to the start of the decay using the free-evolution Hamiltonian.
This is of course not physical, but it allows us to treat the time evolution
after the excitation to be simply the free evolution.
\eqar{
  \begin{split}
    \rho_2=&\Gamma^2\int_0^\infty\ud\tau_1\ue^{-\Gamma\tau_1/2}\int_0^\infty\ud\tau_2\ue^{-\Gamma\tau_2/2}\frac{\paren{|0,A(\tau_1)\rangle+|1,B(\tau_1)\rangle}\paren{\langle 0,A(\tau_2)|+\langle 1,B(\tau_2)|}}{2}\\
           &\ue^{-\ui H\tau_1}\mathcal{D}(\ui\eta_{\mathrm{e}})\ue^{\ui H\tau_1}\mathcal{D}(\ui\eta_{\mathrm{d}})\rho_{\mathrm{m}}\mathcal{D}(-\ui\eta_{\mathrm{d}})
             \ue^{-\ui H\tau_2}\mathcal{D}(-\ui\eta_{\mathrm{e}})\ue^{\ui H\tau_2}\\
  \end{split}
}
where $\tau_1$ and $\tau_2$ are ``emission time'' for the photons.
Substitude in the thermal motional density matrix.
\eqar{
  \begin{split}
    \rho_2=&\frac{\Gamma^2}{\pi {\bar n}}\int_0^\infty\ud\tau_1\ue^{-\Gamma\tau_1/2}\int_0^\infty\ud\tau_2\ue^{-\Gamma\tau_2/2}\frac{\paren{|0,A(\tau_1)\rangle+|1,B(\tau_1)\rangle}\paren{\langle 0,A(\tau_2)|+\langle 1,B(\tau_2)|}}{2}\\
           &\ue^{-\ui H\tau_1}\mathcal{D}(\ui\eta_{\mathrm{e}})\ue^{\ui H\tau_1}\mathcal{D}(\ui\eta_{\mathrm{d}})\int\ud^2\alpha |\alpha\rangle\langle\alpha|\ue^{-\abs{\alpha}^2/{\bar n}}\mathcal{D}(-\ui\eta_{\mathrm{d}})
             \ue^{-\ui H\tau_2}\mathcal{D}(-\ui\eta_{\mathrm{e}})\ue^{\ui H\tau_2}\\
  \end{split}
}
\eqar{
  \begin{split}
    &\ue^{-\ui H\tau_1}\mathcal{D}(\ui\eta_{\mathrm{e}})\ue^{\ui H\tau_1}\mathcal{D}(\ui\eta_{\mathrm{d}})|\alpha\rangle\\
    =&\exp\paren{\ui\eta_{\mathrm{d}}\mathrm{Re}(\alpha)}
       \ue^{-\ui H\tau_1}\mathcal{D}(\ui\eta_{\mathrm{e}})\ue^{\ui H\tau_1}
       |\alpha+\ui\eta_{\mathrm{d}}\rangle\\
    =&\exp\paren{\ui\eta_{\mathrm{d}}\mathrm{Re}(\alpha)}
       \ue^{-\ui H\tau_1}\mathcal{D}(\ui\eta_{\mathrm{e}})
       |\ue^{\ui\omega\tau_1}(\alpha+\ui\eta_{\mathrm{d}})\rangle\\
    =&\exp\paren{\ui\eta_{\mathrm{d}}\mathrm{Re}(\alpha)+\ui\eta_{\mathrm{e}}\mathrm{Re}(\ue^{-\ui\omega\tau_1}(\alpha^*-\ui\eta_{\mathrm{d}}))}
       \ue^{-\ui H\tau_1}
       |\ue^{\ui\omega\tau_1}(\alpha+\ui\eta_{\mathrm{d}})+\ui\eta_{\mathrm{e}}\rangle\\
    =&\exp\paren{\ui\eta_{\mathrm{d}}\mathrm{Re}(\alpha)+\ui\eta_{\mathrm{e}}\mathrm{Re}(\ue^{-\ui\omega\tau_1}(\alpha^*-\ui\eta_{\mathrm{d}}))}
       |\alpha+\ui\eta_{\mathrm{d}}+\ui\eta_{\mathrm{e}}\ue^{-\ui\omega\tau_1}\rangle\\
  \end{split}
}
\eqar{
  \begin{split}
    \rho_2=&\frac{\Gamma^2}{\pi {\bar n}}\int_0^\infty\ud\tau_1\ue^{-\Gamma\tau_1/2}\int_0^\infty\ud\tau_2\ue^{-\Gamma\tau_2/2}\frac{\paren{|0,A(\tau_1)\rangle+|1,B(\tau_1)\rangle}\paren{\langle 0,A(\tau_2)|+\langle 1,B(\tau_2)|}}{2}\\
           &\int\ud^2\alpha
             \exp\paren{\ui\eta_{\mathrm{d}}\mathrm{Re}(\alpha)+\ui\eta_{\mathrm{e}}\mathrm{Re}(\ue^{-\ui\omega\tau_1}(\alpha^*-\ui\eta_{\mathrm{d}}))}
             \exp\paren{-\ui\eta_{\mathrm{d}}\mathrm{Re}(\alpha)-\ui\eta_{\mathrm{e}}\mathrm{Re}(\ue^{-\ui\omega\tau_2}(\alpha^*-\ui\eta_{\mathrm{d}}))}\\
           &\ue^{-\abs{\alpha}^2/{\bar n}}|\alpha+\ui\eta_{\mathrm{d}}+\ui\eta_{\mathrm{e}}\ue^{-\ui\omega\tau_1}\rangle
             \langle\alpha+\ui\eta_{\mathrm{d}}+\ui\eta_{\mathrm{e}}\ue^{-\ui\omega\tau_2}|\\
  \end{split}
}
Note that unlike the previous case, the unwanted entanglement create is entirely
between two degrees of freedoms outside the qubit space
and does not affect the fidelity of an atom-photon entanglement fidelity.
To see the effect of this, we need to look at the state of the two atoms combined.
\eqar{
  \begin{split}
    \rho'_2=
    &\frac{\Gamma^4}{\pi^2 {\bar n_{a}}{\bar n_{b}}}
      \int_0^\infty\ud\tau_{a1}\ue^{-\Gamma\tau_{a1}/2}\int_0^\infty\ud\tau_{a2}\ue^{-\Gamma\tau_{a2}/2}\int_0^\infty\ud\tau_{b1}\ue^{-\Gamma\tau_{b1}/2}\int_0^\infty\ud\tau_{b2}\ue^{-\Gamma\tau_{b2}/2}\\
    &\frac{\paren{|0_a,A_a(\tau_{a1})\rangle+|1_a,B_a(\tau_{a1})\rangle}\paren{\langle 0_a,A_a(\tau_{a2})|+\langle 1_a,B_a(\tau_{a2})|}}{2}\\
    &\frac{\paren{|0_b,A_b(\tau_{b1})\rangle+|1_b,B_b(\tau_{b1})\rangle}\paren{\langle 0_b,A_b(\tau_{b2})|+\langle 1_b,B_b(\tau_{b2})|}}{2}\\
    &\int\ud^2\alpha_a
      \exp\paren{\ui\eta_{a\mathrm{d}}\mathrm{Re}(\alpha_a)+\ui\eta_{a\mathrm{e}}\mathrm{Re}(\ue^{-\ui\omega_a\tau_{a1}}(\alpha_a^*-\ui\eta_{a\mathrm{d}}))}
      \exp\paren{-\ui\eta_{a\mathrm{d}}\mathrm{Re}(\alpha_a)-\ui\eta_{a\mathrm{e}}\mathrm{Re}(\ue^{-\ui\omega_a\tau_{a2}}(\alpha_a^*-\ui\eta_{a\mathrm{d}}))}\\
    &\ue^{-\abs{\alpha_a}^2/{\bar n_a}}|\alpha_a+\ui\eta_{a\mathrm{d}}+\ui\eta_{a\mathrm{e}}\ue^{-\ui\omega_a\tau_{a1}}\rangle
      \langle\alpha_a+\ui\eta_{a\mathrm{d}}+\ui\eta_{a\mathrm{e}}\ue^{-\ui\omega_a\tau_{a2}}|\\
    &\int\ud^2\alpha_b
      \exp\paren{\ui\eta_{b\mathrm{d}}\mathrm{Re}(\alpha_b)+\ui\eta_{b\mathrm{e}}\mathrm{Re}(\ue^{-\ui\omega_b\tau_{b1}}(\alpha_b^*-\ui\eta_{b\mathrm{d}}))}
      \exp\paren{-\ui\eta_{b\mathrm{d}}\mathrm{Re}(\alpha_b)-\ui\eta_{b\mathrm{e}}\mathrm{Re}(\ue^{-\ui\omega_b\tau_{b2}}(\alpha_b^*-\ui\eta_{b\mathrm{d}}))}\\
    &\ue^{-\abs{\alpha_b}^2/{\bar n_b}}|\alpha_b+\ui\eta_{b\mathrm{d}}+\ui\eta_{b\mathrm{e}}\ue^{-\ui\omega_b\tau_{b1}}\rangle
      \langle\alpha_b+\ui\eta_{b\mathrm{d}}+\ui\eta_{b\mathrm{e}}\ue^{-\ui\omega_b\tau_{b2}}|\\
  \end{split}
}

After the beam splitter we have
\eqar{
  A_a(\tau)\rightarrow\frac{1}{\sqrt2}\paren{A^1(\tau)+A^2(\tau)}\\
  B_a(\tau)\rightarrow\frac{1}{\sqrt2}\paren{B^1(\tau)+B^2(\tau)}\\
  A_b(\tau)\rightarrow\frac{1}{\sqrt2}\paren{A^1(\tau)-A^2(\tau)}\\
  B_b(\tau)\rightarrow\frac{1}{\sqrt2}\paren{B^1(\tau)-B^2(\tau)}
}
where $A^1$, $B^1$, $A^2$, $B^2$ are the four potential detections
at the output of the beam splitter.
For simplicity, we'll only consider one detection possiblity $A^1(\tau_A)B^1(\tau_B)$.
We now just need to compute the conditional density matrix when this event happens.
The unnormalized reduced density matrix (trace out motion),
\eqar{
  \begin{split}
    \rho'_3=
    &\int_0^\infty\ud\tau_{a1}\ue^{-\Gamma\tau_{a1}/2}\int_0^\infty\ud\tau_{a2}\ue^{-\Gamma\tau_{a2}/2}\int_0^\infty\ud\tau_{b1}\ue^{-\Gamma\tau_{b1}/2}\int_0^\infty\ud\tau_{b2}\ue^{-\Gamma\tau_{b2}/2}\\
    &\paren{\delta(\tau_{b1}-\tau_A)\delta(\tau_{a1}-\tau_B)|1_a,0_b\rangle+\delta(\tau_{a1}-\tau_A)\delta(\tau_{b1}-\tau_B)|0_a,1_b\rangle}\\
    &\paren{\langle 1_a,0_b|\delta(\tau_{b2}-\tau_A)\delta(\tau_{a2}-\tau_B)+\langle 0_a,1_b|\delta(\tau_{a2}-\tau_A)\delta(\tau_{b2}-\tau_B)}\\
    &\int\ud^2\alpha_a
      \exp\paren{\ui\eta_{a\mathrm{d}}\mathrm{Re}(\alpha_a)+\ui\eta_{a\mathrm{e}}\mathrm{Re}(\ue^{-\ui\omega_a\tau_{a1}}(\alpha_a^*-\ui\eta_{a\mathrm{d}}))}
      \exp\paren{-\ui\eta_{a\mathrm{d}}\mathrm{Re}(\alpha_a)-\ui\eta_{a\mathrm{e}}\mathrm{Re}(\ue^{-\ui\omega_a\tau_{a2}}(\alpha_a^*-\ui\eta_{a\mathrm{d}}))}\\
    &\ue^{-\abs{\alpha_a}^2/{\bar n_a}}\langle\alpha_a+\ui\eta_{a\mathrm{d}}+\ui\eta_{a\mathrm{e}}\ue^{-\ui\omega_a\tau_{a2}}|\alpha_a+\ui\eta_{a\mathrm{d}}+\ui\eta_{a\mathrm{e}}\ue^{-\ui\omega_a\tau_{a1}}\rangle\\
    &\int\ud^2\alpha_b
      \exp\paren{\ui\eta_{b\mathrm{d}}\mathrm{Re}(\alpha_b)+\ui\eta_{b\mathrm{e}}\mathrm{Re}(\ue^{-\ui\omega_b\tau_{b1}}(\alpha_b^*-\ui\eta_{b\mathrm{d}}))}
      \exp\paren{-\ui\eta_{b\mathrm{d}}\mathrm{Re}(\alpha_b)-\ui\eta_{b\mathrm{e}}\mathrm{Re}(\ue^{-\ui\omega_b\tau_{b2}}(\alpha_b^*-\ui\eta_{b\mathrm{d}}))}\\
    &\ue^{-\abs{\alpha_b}^2/{\bar n_b}}\langle\alpha_b+\ui\eta_{b\mathrm{d}}+\ui\eta_{b\mathrm{e}}\ue^{-\ui\omega_b\tau_{b2}}|\alpha_b+\ui\eta_{b\mathrm{d}}+\ui\eta_{b\mathrm{e}}\ue^{-\ui\omega_b\tau_{b1}}\rangle\\
  \end{split}
}
The motion integral,
\eqar{
  \begin{split}
    &\int\ud^2\alpha
      \exp\paren{\ui\eta_{\mathrm{d}}\mathrm{Re}(\alpha)+\ui\eta_{\mathrm{e}}\mathrm{Re}(\ue^{-\ui\omega\tau_{1}}(\alpha^*-\ui\eta_{\mathrm{d}}))}
      \exp\paren{-\ui\eta_{\mathrm{d}}\mathrm{Re}(\alpha)-\ui\eta_{\mathrm{e}}\mathrm{Re}(\ue^{-\ui\omega\tau_{2}}(\alpha^*-\ui\eta_{\mathrm{d}}))}\\
    &\ue^{-\abs{\alpha}^2/{\bar n}}\langle\alpha+\ui\eta_{\mathrm{d}}+\ui\eta_{\mathrm{e}}\ue^{-\ui\omega\tau_{2}}|\alpha+\ui\eta_{\mathrm{d}}+\ui\eta_{\mathrm{e}}\ue^{-\ui\omega\tau_{1}}\rangle\\
    =&\int\ud^2\alpha
       \exp\paren{\ui\eta_{\mathrm{d}}\mathrm{Re}(\alpha)+\ui\eta_{\mathrm{e}}\mathrm{Re}(\ue^{-\ui\omega\tau_{1}}(\alpha^*-\ui\eta_{\mathrm{d}}))}
       \exp\paren{-\ui\eta_{\mathrm{d}}\mathrm{Re}(\alpha)-\ui\eta_{\mathrm{e}}\mathrm{Re}(\ue^{-\ui\omega\tau_{2}}(\alpha^*-\ui\eta_{\mathrm{d}}))}\\
    &\ue^{-\abs{\alpha}^2/{\bar n}}
      \ue^{-\paren{\abs{\alpha+\ui\eta_{\mathrm{d}}+\ui\eta_{\mathrm{e}}\ue^{-\ui\omega\tau_{2}}}^2+\abs{\alpha+\ui\eta_{\mathrm{d}}+\ui\eta_{\mathrm{e}}\ue^{-\ui\omega\tau_{1}}}^2-2\paren{\alpha+\ui\eta_{\mathrm{d}}+\ui\eta_{\mathrm{e}}\ue^{-\ui\omega\tau_{2}}}^*\paren{\alpha+\ui\eta_{\mathrm{d}}+\ui\eta_{\mathrm{e}}\ue^{-\ui\omega\tau_{1}}}}/2}\\
    =&\int\ud^2\alpha
       \exp\paren{\ui\eta_{\mathrm{d}}\mathrm{Re}(\alpha)+\ui\eta_{\mathrm{e}}\mathrm{Re}(\ue^{-\ui\omega\tau_{1}}(\alpha^*-\ui\eta_{\mathrm{d}}))}
       \exp\paren{-\ui\eta_{\mathrm{d}}\mathrm{Re}(\alpha)-\ui\eta_{\mathrm{e}}\mathrm{Re}(\ue^{-\ui\omega\tau_{2}}(\alpha^*-\ui\eta_{\mathrm{d}}))}\\
    &\ue^{-\abs{\alpha}^2/{\bar n}}
      \exp\paren{
      \ui\eta_{\mathrm{e}}\mathrm{Re}\paren{\paren{\alpha+\ui\eta_{\mathrm{d}}}
      \paren{\ue^{\ui\omega\tau_{1}}-\ue^{\ui\omega\tau_{2}}}}
      -\eta_{\mathrm{e}}^2\paren{1-\ue^{\ui\omega\paren{\tau_{2}-\tau_{1}}}}
      }\\
    =&\exp\paren{
       -2\ui\eta_{\mathrm{e}}
       \eta_{\mathrm{d}}\paren{\sin\omega\tau_{1}-\sin\omega\tau_{2}}
       -\eta_{\mathrm{e}}^2\paren{1-\ue^{\ui\omega\paren{\tau_{2}-\tau_{1}}}}
       }\\
    &\int\ud^2\alpha
      \exp\paren{
      -\alpha_x^2/{\bar n}
      +2\ui\eta_{\mathrm{e}}\paren{\cos\omega\tau_{1}-\cos\omega\tau_{2}}\alpha_x
      -\alpha_y^2/{\bar n}
      -2\ui\eta_{\mathrm{e}}\paren{\sin\omega\tau_{1}-\sin\omega\tau_{2}}\alpha_y
      }\\
    =&\exp\paren{
       -2\ui\eta_{\mathrm{e}}
       \eta_{\mathrm{d}}\paren{\sin\omega\tau_{1}-\sin\omega\tau_{2}}
       -\eta_{\mathrm{e}}^2\paren{1-\ue^{\ui\omega\paren{\tau_{2}-\tau_{1}}}}
       }\\
    &\pi{\bar n}\exp\paren{-{\bar n}\eta_{\mathrm{e}}^2\paren{\cos\omega\tau_{1}-\cos\omega\tau_{2}}^2}
      \exp\paren{-{\bar n}\eta_{\mathrm{e}}^2\paren{\sin\omega\tau_{1}-\sin\omega\tau_{2}}^2}\\
    =&\pi{\bar n}\exp\paren{
       -2\ui\eta_{\mathrm{e}}
       \eta_{\mathrm{d}}\paren{\sin\omega\tau_{1}-\sin\omega\tau_{2}}
       -\eta_{\mathrm{e}}^2\paren{1-\ue^{\ui\omega\paren{\tau_{2}-\tau_{1}}}}
       -2{\bar n}\eta_{\mathrm{e}}^2\paren{1-\cos\omega\paren{\tau_1-\tau_2}}
       }
  \end{split}
}
Ignoring the constant factors the unnormalized reduced density matrix,
\eqar{
  \begin{split}
    \rho'_3=
    &\int_0^\infty\ud\tau_{a1}\ue^{-\Gamma\tau_{a1}/2}\int_0^\infty\ud\tau_{a2}\ue^{-\Gamma\tau_{a2}/2}\int_0^\infty\ud\tau_{b1}\ue^{-\Gamma\tau_{b1}/2}\int_0^\infty\ud\tau_{b2}\ue^{-\Gamma\tau_{b2}/2}\\
    &\paren{\delta(\tau_{b1}-\tau_A)\delta(\tau_{a1}-\tau_B)|1_a,0_b\rangle+\delta(\tau_{a1}-\tau_A)\delta(\tau_{b1}-\tau_B)|0_a,1_b\rangle}\\
    &\paren{\langle 1_a,0_b|\delta(\tau_{b2}-\tau_A)\delta(\tau_{a2}-\tau_B)+\langle 0_a,1_b|\delta(\tau_{a2}-\tau_A)\delta(\tau_{b2}-\tau_B)}\\
    &\exp\paren{
      -2\ui\eta_{a\mathrm{e}}
      \eta_{a\mathrm{d}}\paren{\sin\omega_a\tau_{a1}-\sin\omega_a\tau_{a2}}
      -\eta_{a\mathrm{e}}^2\paren{1-\ue^{\ui\omega_a\paren{\tau_{a2}-\tau_{a1}}}}
      -2{\bar n_a}\eta_{a\mathrm{e}}^2\paren{1-\cos\omega_a\paren{\tau_{a1}-\tau_{a2}}}
      }\\
    &\exp\paren{
      -2\ui\eta_{b\mathrm{e}}
      \eta_{b\mathrm{d}}\paren{\sin\omega_b\tau_{b1}-\sin\omega_b\tau_{b2}}
      -\eta_{b\mathrm{e}}^2\paren{1-\ue^{\ui\omega_b\paren{\tau_{b2}-\tau_{b1}}}}
      -2{\bar n_b}\eta_{b\mathrm{e}}^2\paren{1-\cos\omega_b\paren{\tau_{b1}-\tau_{b2}}}
      }
  \end{split}
}


Diagonal element of the reduced density matrix element (trace out motion),
\eqar{
  \begin{split}
    &\langle0_a,1_b|\rho'_3|0_a,1_b\rangle\\
    =&\ue^{-\Gamma\paren{\tau_A+\tau_B}}\\
    &\exp\paren{
      -2\ui\eta_{a\mathrm{e}}
      \eta_{a\mathrm{d}}\paren{\sin\omega_a\tau_{A}-\sin\omega_a\tau_{A}}
      -\eta_{a\mathrm{e}}^2\paren{1-\ue^{\ui\omega_a\paren{\tau_{A}-\tau_{A}}}}
      -2{\bar n_a}\eta_{a\mathrm{e}}^2\paren{1-\cos\omega_a\paren{\tau_{A}-\tau_{A}}}
      }\\
    &\exp\paren{
      -2\ui\eta_{b\mathrm{e}}
      \eta_{b\mathrm{d}}\paren{\sin\omega_b\tau_{B}-\sin\omega_b\tau_{B}}
      -\eta_{b\mathrm{e}}^2\paren{1-\ue^{\ui\omega_b\paren{\tau_{B}-\tau_{B}}}}
      -2{\bar n_b}\eta_{b\mathrm{e}}^2\paren{1-\cos\omega_b\paren{\tau_{B}-\tau_{B}}}
      }\\
    =&\ue^{-\Gamma\tau_A}\ue^{-\Gamma\tau_B}\\
  \end{split}\\
  \begin{split}
    &\langle1_a,0_b|\rho'_3|1_a,0_b\rangle\\
    =&\ue^{-\Gamma\paren{\tau_A+\tau_B}}\\
  \end{split}
}
These suggests that the population isn't affected by this entanglment
and the probability of detect goes as the lifetime suggests.
This result isn't surprising or interesting.\\

Now the more interesting term is the off-diagonal element.
\eqar{
  \begin{split}
    &\langle0_a,1_b|\rho'_3|1_a,0_b\rangle\\
    =&\ue^{-\Gamma\paren{\tau_A+\tau_B}}\\
    &\exp\paren{
      -2\ui\eta_{a\mathrm{e}}
      \eta_{a\mathrm{d}}\paren{\sin\omega_a\tau_{A}-\sin\omega_a\tau_{B}}
      -\eta_{a\mathrm{e}}^2\paren{1-\ue^{\ui\omega_a\paren{\tau_{B}-\tau_{A}}}}
      -2{\bar n_a}\eta_{a\mathrm{e}}^2\paren{1-\cos\omega_a\paren{\tau_{A}-\tau_{B}}}
      }\\
    &\exp\paren{
      -2\ui\eta_{b\mathrm{e}}
      \eta_{b\mathrm{d}}\paren{\sin\omega_b\tau_{B}-\sin\omega_b\tau_{A}}
      -\eta_{b\mathrm{e}}^2\paren{1-\ue^{\ui\omega_b\paren{\tau_{A}-\tau_{B}}}}
      -2{\bar n_b}\eta_{b\mathrm{e}}^2\paren{1-\cos\omega_b\paren{\tau_{B}-\tau_{A}}}
      }\\
    =&\ue^{-\Gamma\paren{\tau_A+\tau_B}}\\
    &\exp\paren{
      -2\ui\paren{\eta_{a\mathrm{e}}\eta_{a\mathrm{d}}+\eta_{b\mathrm{e}}\eta_{b\mathrm{d}}}
      \paren{\sin\omega_a\tau_{A}-\sin\omega_a\tau_{B}}
      -\ui\eta_{a\mathrm{e}}^2\paren{\sin\omega_a\paren{\tau_{A}-\tau_{B}}}
      +\ui\eta_{b\mathrm{e}}^2\paren{\sin\omega_b\paren{\tau_{A}-\tau_{B}}}
      }\\
    &\exp\paren{
      -\paren{2{\bar n_a}+1}\eta_{a\mathrm{e}}^2\paren{1-\cos\omega_a\paren{\tau_{A}-\tau_{B}}}
      }
      \exp\paren{
      -\paren{2{\bar n_b}+1}\eta_{b\mathrm{e}}^2\paren{1-\cos\omega_b\paren{\tau_{A}-\tau_{B}}}
      }\\
  \end{split}
}
We can compare this with the normalization factor to get the real diagonal element.
Similar to the previous case, there is a phase factor that's proportional
to the square of the LD parameters
\eqar{
  \exp\paren{
    -2\ui\paren{\eta_{a\mathrm{e}}\eta_{a\mathrm{d}}+\eta_{b\mathrm{e}}\eta_{b\mathrm{d}}}
    \paren{\sin\omega_a\tau_{A}-\sin\omega_a\tau_{B}}
    -\ui\eta_{a\mathrm{e}}^2\paren{\sin\omega_a\paren{\tau_{A}-\tau_{B}}}
    +\ui\eta_{b\mathrm{e}}^2\paren{\sin\omega_b\paren{\tau_{A}-\tau_{B}}}
  }
}
This factor can be completely ignored for ion experiments.\\

The fidelity factor is,
\eqar{
  \exp\paren{
    -\paren{2{\bar n_a}+1}\eta_{a\mathrm{e}}^2\paren{1-\cos\omega_a\paren{\tau_{A}-\tau_{B}}}
  }
  \exp\paren{
    -\paren{2{\bar n_b}+1}\eta_{b\mathrm{e}}^2\paren{1-\cos\omega_b\paren{\tau_{A}-\tau_{B}}}
  }
}
This is $1$ when $\tau_A=\tau_B$, which makes sense since there's no leakage of
information from the motional state of the atoms.


\end{document}
