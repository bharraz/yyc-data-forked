\documentclass[10pt,fleqn]{article}
% \usepackage[journal=rsc]{chemstyle}
% \usepackage{mhchem}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{amsfonts}
\usepackage{esint}
\usepackage{bbm}
\usepackage{amscd}
\usepackage{picinpar}
\usepackage{graphicx}
\usepackage{tikz}
\usepackage{tikz-3dplot}
\usepackage{indentfirst}
\usepackage{wrapfig}
\usepackage{units}
\usepackage{textcomp}
\usepackage[utf8x]{inputenc}
% \usepackage{feyn}
% \usepackage{feynmp}
\usepackage{xkeyval}
\usepackage{xargs}
\usepackage{verbatim}
\usepackage{pgfplots}
\usepackage{hyperref}
\usetikzlibrary{
  arrows,
  calc,
  decorations.pathmorphing,
  decorations.pathreplacing,
  decorations.markings,
  fadings,
  positioning,
  shapes
}

\pgfdeclareradialshading{glow2}{\pgfpoint{0cm}{0cm}}{
  color(0mm)=(white);
  color(2mm)=(white);
  color(8mm)=(black);
  color(10mm)=(black)
}
\pgfdeclareradialshading{glow}{\pgfpoint{0cm}{0cm}}{
  color(0mm)=(white);
  color(5mm)=(white);
  color(9mm)=(black);
  color(10mm)=(black)
}

\begin{tikzfadingfrompicture}[name=glow fading]
  \shade [shading=glow] (0,0) circle (1);
\end{tikzfadingfrompicture}

\begin{tikzfadingfrompicture}[name=glow2 fading]
  \shade [shading=glow2] (0,0) circle (1);
\end{tikzfadingfrompicture}

\definecolor{pyplotc0}{rgb}{0.122,0.467,0.706}
\definecolor{pyplotc1}{rgb}{1.000,0.498,0.055}
\definecolor{pyplotc2}{rgb}{0.173,0.627,0.173}
\definecolor{pyplotc3}{rgb}{0.839,0.153,0.157}
\definecolor{pyplotc4}{rgb}{0.580,0.404,0.741}
\definecolor{pyplotc5}{rgb}{0.549,0.337,0.294}
\definecolor{pyplotc6}{rgb}{0.890,0.467,0.761}
\definecolor{pyplotc7}{rgb}{0.498,0.498,0.498}
\definecolor{pyplotc8}{rgb}{0.737,0.741,0.133}
\definecolor{pyplotc9}{rgb}{0.090,0.745,0.812}

\DeclareGraphicsRule{*}{mps}{*}{}
\newcommand{\ud}{\mathrm{d}}
\newcommand{\ue}{\mathrm{e}}
\newcommand{\ui}{\mathrm{i}}
\newcommand{\res}{\mathrm{Res}}
\newcommand{\Tr}{\mathrm{Tr}}
\newcommand{\dsum}{\displaystyle\sum}
\newcommand{\dprod}{\displaystyle\prod}
\newcommand{\dlim}{\displaystyle\lim}
\newcommand{\dint}{\displaystyle\int}
\newcommand{\fsno}[1]{{\!\not\!{#1}}}
\newcommand{\eqar}[1]
{
  \begin{align}
    #1
  \end{align}
}
\newcommand{\texp}[2]{\ensuremath{{#1}\times10^{#2}}}
\newcommand{\dexp}[2]{\ensuremath{{#1}\cdot10^{#2}}}
\newcommand{\eval}[2]{{\left.{#1}\right|_{#2}}}
\newcommand{\paren}[1]{{\left({#1}\right)}}
\newcommand{\lparen}[1]{{\left({#1}\right.}}
\newcommand{\rparen}[1]{{\left.{#1}\right)}}
\newcommand{\abs}[1]{{\left|{#1}\right|}}
\newcommand{\sqr}[1]{{\left[{#1}\right]}}
\newcommand{\crly}[1]{{\left\{{#1}\right\}}}
\newcommand{\angl}[1]{{\left\langle{#1}\right\rangle}}
\newcommand{\tpdiff}[4][{}]{{\paren{\frac{\partial^{#1} {#2}}{\partial {#3}{}^{#1}}}_{#4}}}
\newcommand{\tpsdiff}[4][{}]{{\paren{\frac{\partial^{#1}}{\partial {#3}{}^{#1}}{#2}}_{#4}}}
\newcommand{\pdiff}[3][{}]{{\frac{\partial^{#1} {#2}}{\partial {#3}{}^{#1}}}}
\newcommand{\diff}[3][{}]{{\frac{\ud^{#1} {#2}}{\ud {#3}{}^{#1}}}}
\newcommand{\psdiff}[3][{}]{{\frac{\partial^{#1}}{\partial {#3}{}^{#1}} {#2}}}
\newcommand{\sdiff}[3][{}]{{\frac{\ud^{#1}}{\ud {#3}{}^{#1}} {#2}}}
\newcommand{\tpddiff}[4][{}]{{\left(\dfrac{\partial^{#1} {#2}}{\partial {#3}{}^{#1}}\right)_{#4}}}
\newcommand{\tpsddiff}[4][{}]{{\paren{\dfrac{\partial^{#1}}{\partial {#3}{}^{#1}}{#2}}_{#4}}}
\newcommand{\pddiff}[3][{}]{{\dfrac{\partial^{#1} {#2}}{\partial {#3}{}^{#1}}}}
\newcommand{\ddiff}[3][{}]{{\dfrac{\ud^{#1} {#2}}{\ud {#3}{}^{#1}}}}
\newcommand{\psddiff}[3][{}]{{\frac{\partial^{#1}}{\partial{}^{#1} {#3}} {#2}}}
\newcommand{\sddiff}[3][{}]{{\frac{\ud^{#1}}{\ud {#3}{}^{#1}} {#2}}}
\usepackage{fancyhdr}
\usepackage{multirow}
\usepackage{fontenc}
% \usepackage{tipa}
\usepackage{ulem}
\usepackage{color}
\usepackage{cancel}
\newcommand{\hcancel}[2][black]{\setbox0=\hbox{#2}%
  \rlap{\raisebox{.45\ht0}{\textcolor{#1}{\rule{\wd0}{1pt}}}}#2}
\pagestyle{fancy}
\setlength{\headheight}{67pt}
\fancyhead{}
\fancyfoot{}
\fancyfoot[C]{\thepage}
\fancyhead[R]{}
\renewcommand{\footruleskip}{0pt}
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0pt}

\newcommand\pgfmathsinandcos[3]{%
  \pgfmathsetmacro#1{sin(#3)}%
  \pgfmathsetmacro#2{cos(#3)}%
}
\newcommand\LongitudePlane[3][current plane]{%
  \pgfmathsinandcos\sinEl\cosEl{#2} % elevation
  \pgfmathsinandcos\sint\cost{#3} % azimuth
  \tikzset{#1/.estyle={cm={\cost,\sint*\sinEl,0,\cosEl,(0,0)}}}
}
\newcommand\LatitudePlane[3][current plane]{%
  \pgfmathsinandcos\sinEl\cosEl{#2} % elevation
  \pgfmathsinandcos\sint\cost{#3} % latitude
  \pgfmathsetmacro\yshift{\cosEl*\sint}
  \tikzset{#1/.estyle={cm={\cost,0,0,\cost*\sinEl,(0,\yshift)}}} %
}
\newcommand\DrawLongitudeCircle[2][1]{
  \LongitudePlane{\angEl}{#2}
  \tikzset{current plane/.prefix style={scale=#1}}
  % angle of "visibility"
  \pgfmathsetmacro\angVis{atan(sin(#2)*cos(\angEl)/sin(\angEl))} %
  \draw[current plane] (\angVis:1) arc (\angVis:\angVis+180:1);
  \draw[current plane,dashed] (\angVis-180:1) arc (\angVis-180:\angVis:1);
}
\newcommand\DrawLatitudeCircleArrow[2][1]{
  \LatitudePlane{\angEl}{#2}
  \tikzset{current plane/.prefix style={scale=#1}}
  \pgfmathsetmacro\sinVis{sin(#2)/cos(#2)*sin(\angEl)/cos(\angEl)}
  % angle of "visibility"
  \pgfmathsetmacro\angVis{asin(min(1,max(\sinVis,-1)))}
  \draw[current plane,decoration={markings, mark=at position 0.6 with {\arrow{<}}},postaction={decorate},line width=.6mm] (\angVis:1) arc (\angVis:-\angVis-180:1);
  \draw[current plane,dashed,line width=.6mm] (180-\angVis:1) arc (180-\angVis:\angVis:1);
}
\newcommand\DrawLatitudeCircle[2][1]{
  \LatitudePlane{\angEl}{#2}
  \tikzset{current plane/.prefix style={scale=#1}}
  \pgfmathsetmacro\sinVis{sin(#2)/cos(#2)*sin(\angEl)/cos(\angEl)}
  % angle of "visibility"
  \pgfmathsetmacro\angVis{asin(min(1,max(\sinVis,-1)))}
  \draw[current plane] (\angVis:1) arc (\angVis:-\angVis-180:1);
  \draw[current plane,dashed] (180-\angVis:1) arc (180-\angVis:\angVis:1);
}
\newcommand\coil[1]{
  {\rh * cos(\t * pi r)}, {\apart * (2 * #1 + \t) + \rv * sin(\t * pi r)}
}
\makeatletter
\define@key{DrawFromCenter}{style}[{->}]{
  \tikzset{DrawFromCenterPlane/.style={#1}}
}
\define@key{DrawFromCenter}{r}[1]{
  \def\@R{#1}
}
\define@key{DrawFromCenter}{center}[(0, 0)]{
  \def\@Center{#1}
}
\define@key{DrawFromCenter}{theta}[0]{
  \def\@Theta{#1}
}
\define@key{DrawFromCenter}{phi}[0]{
  \def\@Phi{#1}
}
\presetkeys{DrawFromCenter}{style, r, center, theta, phi}{}
\newcommand*\DrawFromCenter[1][]{
  \setkeys{DrawFromCenter}{#1}{
    \pgfmathsinandcos\sint\cost{\@Theta}
    \pgfmathsinandcos\sinp\cosp{\@Phi}
    \pgfmathsinandcos\sinA\cosA{\angEl}
    \pgfmathsetmacro\DX{\@R*\cost*\cosp}
    \pgfmathsetmacro\DY{\@R*(\cost*\sinp*\sinA+\sint*\cosA)}
    \draw[DrawFromCenterPlane] \@Center -- ++(\DX, \DY);
  }
}
\newcommand*\DrawFromCenterText[2][]{
  \setkeys{DrawFromCenter}{#1}{
    \pgfmathsinandcos\sint\cost{\@Theta}
    \pgfmathsinandcos\sinp\cosp{\@Phi}
    \pgfmathsinandcos\sinA\cosA{\angEl}
    \pgfmathsetmacro\DX{\@R*\cost*\cosp}
    \pgfmathsetmacro\DY{\@R*(\cost*\sinp*\sinA+\sint*\cosA)}
    \draw[DrawFromCenterPlane] \@Center -- ++(\DX, \DY) node {#2};
  }
}
\makeatother

\makeatletter
\renewcommand*\env@matrix[1][\arraystretch]{%
  \edef\arraystretch{#1}%
  \hskip -\arraycolsep
  \let\@ifnextchar\new@ifnextchar
  \array{*\c@MaxMatrixCols c}}
\makeatother

\tikzstyle{snakearrow} = [decorate, decoration={pre length=0.2cm,
  post length=0.2cm, snake, amplitude=.4mm,
  segment length=2mm},thick, ->]
%% document-wide tikz options and styles
\tikzset{%
  >=latex, % option for nice arrows
  inner sep=0pt,%
  outer sep=2pt,%
  mark coordinate/.style={inner sep=0pt,outer sep=0pt,minimum size=3pt,
    fill=black,circle}%
}
\addtolength{\hoffset}{-1.3cm}
\addtolength{\voffset}{-2cm}
\addtolength{\textwidth}{3cm}
\addtolength{\textheight}{2.5cm}
\renewcommand{\footskip}{10pt}
\setlength{\headwidth}{\textwidth}
\setlength{\headsep}{20pt}
\setlength{\marginparwidth}{0pt}
\parindent=0pt
\title{Ion-photon state fidelity}
\author{Yichao Yu}

\ifpdf
  % Ensure reproducible output
  \pdfinfoomitdate=1
  \pdfsuppressptexinfo=-1
  \pdftrailerid{}
  \hypersetup{
    pdfcreator={},
    pdfproducer={}
  }
\fi

\begin{document}

\maketitle

\section{Goal}

Entangling two qudits by pair-wise interference of the photons emitted from each qudit states produces entangled qubit states in which the two qubit states are probabilitically distributed between different qudit state pairs.
However, the state produced this way, a qubit Bell state, contains less entanglement than the original atom-photon states.
While making full use of the atom-photon state may require complex optical setup, it would still be interesting to put a bound on the atom-photon state fidelity based on the pairwise entanglement result.

\section{Definition of fidelity}
Given an target state $|\psi\rangle$, the fidelity of a density matrix $\rho$ is defined as its overlap with the state,
\eqar{
  f=&\langle\psi|\rho|\psi\rangle
}

The $d$-dimensional target state for the atom-photon pair is,
\eqar{
  |\psi_0\rangle=&\frac{1}{\sqrt{d}}\sum_{n}|n_A,n_P\rangle
}
where the A and P subscripts are for the atom and photon state. The target state for the pair-wise atom-atom state between the $m$ and $n$-th qudit is,
\eqar{
  |\psi_0\rangle_{mn}=&\frac{|mn\rangle+|nm\rangle}{\sqrt{2}}
}
where $m$ and $n$ are the two qudit state entangled.
However, both of these states contain phase degrees of freedoms that does not affect their utility as long as the phase is known/can be measured.
It is therefore more useful to define the fidelity as the maximum overlap between the density matrix and the target state while varying the phase of the target state.\\

For the $d$-dimensional atom-photon state, the final fidelity is,
\eqar{
  \label{eq:fid-ap}
  f^{AP}=&\frac{1}{d}\max_{\{\phi\}}\sum_{m,n}\ue^{\ui\paren{\phi_n-\phi_m}}\langle m_A,m_P|\rho|n_A,n_P\rangle\nonumber\\
  =&\frac{1}{d}+\frac{2}{d}\max_{\{\phi\}}\sum_{m<n}\mathrm{Re}\paren{\ue^{\ui\paren{\phi_n-\phi_m}}\langle m_A,m_P|\rho|n_A,n_P\rangle}
}
For the atom-atom Bell state, the final fidelity is,
\eqar{
  \label{eq:fid-aa}
  f^{AA}_{mn}=&\frac12\max_{\phi}\paren{\langle mn|+\ue^{-\ui\phi}\langle nm|}\rho\paren{|mn\rangle+\ue^{\ui\phi}|nm\rangle}\nonumber\\
  =&\frac12+\abs{\langle mn|\rho|nm\rangle}
}
The second step in the derivation for both assumes that the density matrix is normalized to the subspace span by the states involved.
If the probability of being in this subspace is not $1$, this probability should be multiplied with the number here to obtain the full fidelity.
It is worth noting that in both cases, the fidelity does not depend explicitly on the diagonal elements of the density matrix.

\section{Relation between the fidelity/density matrix of the atom-atom and atom-photon state}
\subsection{Correlation}
First we discuss the probability of the system being in the correct Hilbert space, the one where the state of the photon to be perfectly correlated with the atom that emits the photon.
If the probability of atom-photon pair $i=1,2$ being outside the correlated Hilbert space is $\varepsilon^i_C$, the probability of the ion-ion state being outside the correlated Hilbert space is,
\eqar{
  \varepsilon'_C\geqslant&\varepsilon_{C1}+\varepsilon_{C2}
}
so we have a bound for the atom-photon correlation $\varepsilon^i_C\leqslant\varepsilon'_C$. This could potentially also be bound directly by measuring the single chamber atom-photon correlation.

\subsection{Fidelity within perfectly correlated subspace}
From now on, we can assume both atom-photon pairs are in the perfectly correlated Hilbert space $|n_A,n_P\rangle^i$. With the ion-photon density matrix $\rho^i\equiv\dsum_{m,n}|m_A,m_P\rangle^i\rho_{mn}^i\langle n_A,n_P|^i$ for the $i$-th pair.
The (unnormalized) density matrix after detecting two photons in the $n$ and $m$ time bins is,
\eqar{
  P_{mn}(\rho^1\rho^2)=&\begin{pmatrix}
                         \rho^1_{nn}\rho^2_{mm}&\rho^1_{nm}\rho^2_{mn}\\
                         \rho^1_{mn}\rho^2_{nm}&\rho^1_{mm}\rho^2_{nn}
                        \end{pmatrix}
}
which gives a rate of
\eqar{
  r_{mn}=&\rho^1_{nn}\rho^2_{mm}+\rho^1_{mm}\rho^2_{nn}
}
and a fidelity of (eq.~\ref{eq:fid-aa} extended for unnormalized density matrix)
\eqar{
  \label{eq:fid-aa-rate}
  f_{mn}=&\frac12+\frac{\abs{\rho^1_{nm}\rho^2_{mn}}}{r_{mn}}
}
The atom-atom entanglement measurement allows both $r_{mn}$ and $f_{mn}$ to be bounded, which in turns provides a bound for the atom-photon state fidelity.
In particular, the balance between $r_{mn}$'s constraint the diagonal elements of the atom-photon density matrix and the atom-atom fidelities $f_{mn}$ constraint ratio of the absolute values of the off-diagonal elements and the diagonal elements.
Although the diagonal elements doesn't directly affect the atom-photon fidelity~(eq.~\ref{eq:fid-ap}), they do involve in the constraints on the off-diagonal elements~(eq~\ref{eq:fid-aa-rate}) and also in the constraints from the positive-semidefinity of the density matrix (see below).\\

The phase of the atom-atom state is also measured. However, the phase is the sum of the phase from the two atom-photon state and therefore is a bit difficult to use as constraints on the phase of the individual atom-photon state.

\section{Numerical calculation}
I was unable to derive an analytical expression for the atom-photon fidelity $f^{AP}$ and therefore had to use numerical optimization to bound the fidelity.

\subsection{Physical constraints on the density matrix}
Other than the constraints listed above (mostly on the absolute values of the matrix elements), the density matrix is further constrained since it must be a positive semidefinite matrix.
This constraint is important since allowing arbitrary phase on the off-diagonal matrix element of the density matrix could produce non-physical density matrix with very small, or even negative fidelities.
Numerically, this constraint can be expressed using the Sylvester's criterion, which stated that the leading principal minors must be non-negative.
However, during optimization, it was found that this constraint is not numerically robust, but can be improved by requiring the determinant of all of the sub-density matrixes to be non-negative.

\subsection{All constraints}
In all, the constraints used for optimization are.

\begin{enumerate}
\item Lower and upper bound on the atom-atom entangling rates
  \eqar{
    &r_{mn}^{\mathrm{lo}}\leqslant r_{mn} \leqslant r_{mn}^{\mathrm{hi}}\leqslant
  }
\item Lower and upper bound on the atom-atom entangling fidelities
  \eqar{
    &f_{mn}^{\mathrm{lo}}\leqslant f_{mn} \leqslant f_{mn}^{\mathrm{hi}}\leqslant
  }
\item Both of the atom-photon desity matrices are positive-semidefinite.
\end{enumerate}

\subsection{Implementation notes}
The degrees of freedoms of the problem can be slightly reduced by removing redundant phase variables.
In eq.~\ref{eq:fid-ap}, we can set the phase for the first state $\phi_1$ to $0$.
This corresponds to a global phase that does not affect the result.
Similarly, we can also require the off-diagnonal matrix elements for the first row and column of the atom-photon density matrix to be real numbers, this is always possible to achieve by varying the phases on the basis, which does not affect the fidelity.\\

The optimization for both problems (computing the maximum fidelity given a qudit density matrix and computing the minimum atom-photon fidelity given constraints from atom-atom rate and fidelity) are implemented with gradient based local optimizations\footnote{I settled on \textit{NLOPT\_LD\_TNEWTON\_PRECOND\_RESTART} for finding the max fidelity and \textit{LD\_SLSQP} for finding the minimum fidelity bound}. For finding the atom-photon fidelity bound given the atom-atom result constraints, I find that it is more reliable to do multiple rounds of optimizations and use random sampling to find an off-diagonal phase that could minimize the fidelities. This seems to help the optimizer to get out of any local minima. OTOH, the gradient based optimizer seems to have less trouble finding the distribution of diagonal matrix elements that minimizes the fidelity.

\end{document}
